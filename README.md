# Exim SMTP Relay Ansible Playbook

Ansible playbook to deploy and configure Exim4 as an SMTP relay server on Ubuntu 24.04 LTS for local network mail delivery.

## Features

- ✅ Automated Exim4 installation and configuration
- ✅ SMTP relay for local network
- ✅ TLS/SSL encryption support
- ✅ Rate limiting for spam prevention
- ✅ Firewall configuration (UFW)
- ✅ Security hardening
- ✅ Self-signed certificate generation
- ✅ Idempotent playbook design

## Requirements

- **Control Node**: Ansible 2.9+ installed
- **Target Servers**: Ubuntu 24.04 LTS
- **SSH Access**: Passwordless SSH access to target servers
- **Privileges**: sudo/root access on target servers

## Directory Structure

```
exim-smtp-relay/
├── ansible.cfg           # Ansible configuration
├── inventory.ini         # Server inventory
├── playbook.yml          # Main playbook
├── templates/
│   ├── update-exim4.conf.conf.j2       # Exim config template
│   └── exim4.conf.localmacros.j2       # Security macros template
└── README.md            # This file
```

## Quick Start

### 1. Clone the Repository

```bash
git clone <repository-url>
cd exim-smtp-relay
```

### 2. Configure Inventory

Edit `inventory.ini` and add your mail relay server(s):

```ini
[mail_relay]
relay01 ansible_host=192.168.1.10 ansible_user=ubuntu
```

### 3. Customize Variables

Edit `playbook.yml` and modify the variables section:

```yaml
vars:
  local_network: "192.168.1.0/24"  # Your local network CIDR
  mail_name: "mail.example.com"    # Your mail server FQDN
```

### 4. Run the Playbook

```bash
# Check connectivity
ansible -i inventory.ini mail_relay -m ping

# Run the playbook
ansible-playbook -i inventory.ini playbook.yml

# Run with verbose output
ansible-playbook -i inventory.ini playbook.yml -v
```

## Configuration Options

### Main Variables (in playbook.yml)

| Variable | Description | Default |
|----------|-------------|---------|
| `local_network` | Network CIDR allowed to relay | `192.168.1.0/24` |
| `relay_domains` | Domains to relay for | Empty (local only) |
| `mail_name` | Server FQDN | `{{ ansible_fqdn }}` |
| `local_interfaces` | IPs to listen on | Empty (all interfaces) |
| `enable_tls` | Enable TLS encryption | `true` |
| `enable_rate_limiting` | Enable rate limiting | `true` |
| `smtp_accept_max_per_host` | Max connections per host | `20` |

### Network Configuration Examples

**Single Network:**
```yaml
local_network: "192.168.1.0/24"
```

**Multiple Networks:**
```yaml
local_network: "192.168.1.0/24 : 10.0.0.0/8"
```

**Specific IPs:**
```yaml
local_network: "192.168.1.10 : 192.168.1.20"
```

## Testing the Configuration

### 1. Check Exim Status

```bash
sudo systemctl status exim4
sudo exim4 -bV  # Show version
```

### 2. Test SMTP Relay

From a machine in your local network:

```bash
# Using swaks
swaks --to recipient@example.com \
      --from sender@yourdomain.com \
      --server YOUR_RELAY_IP \
      --body "Test message"

# Using telnet
telnet YOUR_RELAY_IP 25
EHLO test.local
MAIL FROM: <sender@test.local>
RCPT TO: <recipient@example.com>
DATA
Subject: Test
This is a test.
.
QUIT
```

### 3. Check Logs

```bash
sudo tail -f /var/log/exim4/mainlog
sudo tail -f /var/log/exim4/rejectlog
```

## Security Considerations

### Implemented Security Measures

1. **Rate Limiting**: Prevents spam/abuse
2. **TLS Encryption**: Self-signed certificates (replace with CA-signed in production)
3. **Network Restriction**: Only specified networks can relay
4. **Firewall Rules**: UFW configured for SMTP ports
5. **DNS Queries**: Reverse DNS checks available

### Production Recommendations

1. **Use CA-signed Certificates**: Replace self-signed certificates
2. **Configure SPF/DKIM**: Add proper email authentication
3. **Monitor Logs**: Set up log monitoring and alerting
4. **Regular Updates**: Keep Exim and Ubuntu updated
5. **Backup Configuration**: Regular config backups

## Troubleshooting

### Common Issues

**Issue: Relay not permitted**
```bash
# Check relay_nets configuration
sudo grep relay_nets /etc/exim4/update-exim4.conf.conf
```

**Issue: TLS errors**
```bash
# Verify certificate permissions
ls -la /etc/exim4/exim.{crt,key}
# Check certificate details
openssl x509 -in /etc/exim4/exim.crt -text -noout
```

**Issue: Service won't start**
```bash
# Check configuration syntax
sudo exim4 -bV
sudo exim4 -C /var/lib/exim4/config.autogenerated -bV
# View detailed logs
sudo journalctl -u exim4 -n 50
```

## Playbook Tags

Run specific parts of the playbook:

```bash
# Only install packages
ansible-playbook -i inventory.ini playbook.yml --tags packages

# Only configuration
ansible-playbook -i inventory.ini playbook.yml --tags configuration

# Only security settings
ansible-playbook -i inventory.ini playbook.yml --tags security

# Skip firewall configuration
ansible-playbook -i inventory.ini playbook.yml --skip-tags firewall
```

## Advanced Usage

### Using Vault for Sensitive Data

```bash
# Create encrypted variables file
ansible-vault create group_vars/mail_relay/vault.yml

# Run with vault
ansible-playbook -i inventory.ini playbook.yml --ask-vault-pass
```

### Integration with Existing Playbooks

```yaml
- name: Deploy infrastructure
  import_playbook: infrastructure.yml

- name: Deploy Exim relay
  import_playbook: playbook.yml
```

## Maintenance

### Update Exim Configuration

```bash
# Re-run playbook to update config
ansible-playbook -i inventory.ini playbook.yml --tags configuration
```

### Backup Configuration

```bash
# Backup is created automatically with .backup extension
# Manual backup:
sudo cp /etc/exim4/update-exim4.conf.conf \
       /etc/exim4/update-exim4.conf.conf.backup
```

## References

- [Exim Official Documentation](https://www.exim.org/docs.html)
- [Ubuntu Exim4 Guide](https://help.ubuntu.com/community/Exim4)
- [Ansible Documentation](https://docs.ansible.com/)

## License

MIT License - Feel free to modify and distribute

## Contributing

Contributions are welcome! Please submit pull requests or open issues for bugs and feature requests.

## Author

Generated for Ubuntu 24.04 LTS deployment